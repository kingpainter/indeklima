blueprint:
  name: Indeklima - Rum Notifikation (v2.3.1)
  description: >
    Send notifikation nÃ¥r indeklimaet i et specifikt rum bliver dÃ¥rligt.
    Inkluderer smart cooldown sÃ¥ du ikke fÃ¥r for mange beskeder.
    
    **KOMPATIBEL MED v2.3.1** - Bruger engelske konstanter internt.
  domain: automation
  source_url: https://github.com/kingpainter/indeklima/blob/main/blueprints/automation/indeklima/room_notification.yaml
  
  input:
    room_sensor:
      name: Rum Sensor
      description: VÃ¦lg status sensor for det rum du vil overvÃ¥ge
      selector:
        entity:
          domain: sensor
          integration: indeklima
    
    notify_service:
      name: Notifikations Service
      description: Hvilken notify service skal bruges? (f.eks. notify.mobile_app_flemming_mobil)
      selector:
        target:
          entity:
            domain: notify
    
    severity_threshold:
      name: Alvorligheds TÃ¦rskel
      description: Send kun notifikation ved denne status eller vÃ¦rre
      default: "warning"
      selector:
        select:
          options:
            - label: "Advarsel"
              value: "warning"
            - label: "DÃ¥rlig"
              value: "critical"
    
    cooldown_hours:
      name: Cooldown Timer (timer)
      description: Minimum tid mellem notifikationer for samme rum
      default: 2
      selector:
        number:
          min: 0.5
          max: 24
          step: 0.5
          unit_of_measurement: timer
          mode: slider
    
    time_start:
      name: Aktiv Fra
      description: Send kun notifikationer efter dette tidspunkt
      default: "09:00:00"
      selector:
        time:
    
    time_end:
      name: Aktiv Til
      description: Send kun notifikationer fÃ¸r dette tidspunkt
      default: "21:00:00"
      selector:
        time:
    
    include_ventilation_tip:
      name: Inkluder Ventilations Tip
      description: TilfÃ¸j ventilationsanbefaling i beskeden
      default: true
      selector:
        boolean:

mode: single
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input room_sensor
    to:
      - "warning"    # English constant - translates to "Advarsel" in UI
      - "critical"   # English constant - translates to "DÃ¥rlig" in UI
    for:
      minutes: 5

condition:
  - condition: time
    after: !input time_start
    before: !input time_end
  
  - condition: template
    value_template: >
      {% set threshold = !input severity_threshold %}
      {% set current = trigger.to_state.state %}
      {% if threshold == 'critical' %}
        {{ current == 'critical' }}
      {% else %}
        {{ current in ['warning', 'critical'] }}
      {% endif %}
  
  - condition: template
    value_template: >
      {% set last_notified = state_attr(trigger.entity_id, 'last_notified') %}
      {% if last_notified %}
        {{ (now() - as_datetime(last_notified)).total_seconds() / 3600 > !input cooldown_hours }}
      {% else %}
        true
      {% endif %}

action:
  - variables:
      room_name: >
        {{ state_attr(trigger.entity_id, 'friendly_name') | replace('Indeklima ', '') | replace(' Status', '') }}
      fugtighed: >
        {{ state_attr(trigger.entity_id, 'fugtighed') | default('N/A') }}
      co2: >
        {{ state_attr(trigger.entity_id, 'co2') | default('N/A') }}
      temperatur: >
        {{ state_attr(trigger.entity_id, 'temperatur') | default('N/A') }}
      ventilation_status: >
        {{ states('sensor.indeklima_hub_ventilationsanbefaling') | default('N/A') }}
      ventilation_reason: >
        {{ state_attr('sensor.indeklima_hub_ventilationsanbefaling', 'begrundelse') | default('') }}
      # Translate status to Danish for notification
      status_dansk: >
        {% if trigger.to_state.state == 'critical' %}DÃ¥rlig
        {% elif trigger.to_state.state == 'warning' %}Advarsel
        {% else %}{{ trigger.to_state.state }}{% endif %}
  
  - service: !input notify_service
    data:
      title: "ðŸ  Indeklima: {{ room_name }}"
      message: >
        Status: {{ status_dansk }}
        
        {% if fugtighed != 'N/A' %}ðŸŒ¡ï¸ Fugtighed: {{ fugtighed }}%{% endif %}
        {% if co2 != 'N/A' %}ðŸ’¨ CO2: {{ co2 }} ppm{% endif %}
        {% if temperatur != 'N/A' %}ðŸŒ¡ï¸ Temperatur: {{ temperatur }}Â°C{% endif %}
        
        {% if !input include_ventilation_tip and ventilation_status != 'N/A' %}
        
        ðŸ’¡ Ventilation: {{ ventilation_status }}
        {% if ventilation_reason %}{{ ventilation_reason }}{% endif %}
        {% endif %}
      data:
        tag: "indeklima_{{ room_name | lower | replace(' ', '_') }}"
        group: "indeklima"
        notification_icon: mdi:home-alert
        color: >
          {% if trigger.to_state.state == 'critical' %}red{% else %}orange{% endif %}
